<!DOCTYPE html>
<html lang="en">
  <%- include('../partials/head', {
    cssFiles: ['shop/product-card.css','shop/cart2.css'],
    scripts: ['shop/cart.js']
  }) %>
  <body>
    <%- include('../partials/navbar') %>

    <main id="main-content">
      <section class="section" aria-labelledby="cart-title">
        <div class="container">
          <header class="section__header">
            <h1 id="cart-title" class="section__title">Your cart</h1>
          </header>

          <%- include('../partials/flash') %>

          <% const hasItems = items && items.length; %>

          <% if (!hasItems) { %>
            <div class="empty">
              <p class="prose">Your cart is empty.</p>
              <a class="button primary" href="/shop">Browse products</a>
            </div>
          <% } else { %>
            <div class="cart-layout">
              <!-- Left: Items -->
              <div class="cart-items" aria-label="Cart items">
                <ul class="cart-items__list">
                  <% items.forEach(item => { %>
                    <li class="cart-item">
                      <!-- Image -->
                      <div class="cart-item__media">
                        <% if (item.image) { %>
                          <a
                            href="/product/<%= item.slug %>"
                            class="cart-item-thumb"
                          >
                            <img
                              src="<%= item.image.url %>"
                              alt="<%= item.image.alt || item.name %>"
                              loading="lazy"
                            />
                          </a>
                        <% } else { %>
                          <div class="cart-item__placeholder" aria-hidden="true">
                            No image
                          </div>
                        <% } %>
                      </div>

                      <!-- Info + controls -->
                      <div class="cart-item__info">
                        <h2 class="cart-item__name">
                          <a href="/product/<%= item.slug %>" class="link">
                            <%= item.name %>
                          </a>
                        </h2>

                        <p class="cart-item__price">
                          <%= item.priceDisplay %>
                        </p>

                        <!-- ONE form per item: handles update + remove -->
                        <form
                          method="post"
                          action="/cart/update"
                          class="cart-item__controls"
                        >
                          <% if (csrfToken) { %>
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <% } %>

                          <label
                            class="cart-item__qty-label"
                            for="qty-<%= item.productId %>"
                          >
                            Qty
                          </label>

                          <select
                            id="qty-<%= item.productId %>"
                            name="quantities[<%= item.productId %>]"
                            class="cart-item__qty-select"
                            onchange="this.form.submit()"
                          >
                            <% for (let q = 1; q <= 10; q++) { %>
                              <option
                                value="<%= q %>"
                                <%= q === item.quantity ? 'selected' : '' %>
                              >
                                <%= q %>
                              </option>
                            <% } %>
                          </select>

                          <!-- Remove: overrides action to /cart/remove -->
                          <button
                            type="submit"
                            class="link--icon cart-item__remove"
                            formaction="/cart/remove"
                            name="product_id"
                            value="<%= item.productId %>"
                            aria-label="Remove <%= item.name %> from cart"
                          >
                            <span class="sr-only">Remove</span>
                            <%- include('../icon', { name: 'trash' }) %>
                          </button>
                        </form>
                      </div>

                      <!-- Line total -->
                      <div class="cart-item__line-total">
                        <span class="cart-item__line-label">Total</span>
                        <span class="cart-item__line-price">
                          <%= item.lineTotalDisplay %>
                        </span>
                      </div>
                    </li>
                  <% }); %>
                </ul>

                <div class="form-row form-actions">
                  <a class="button link" href="/shop">Continue shopping</a>
                </div>
              </div>

              <!-- Right: Summary -->
              <aside class="cart-summary" aria-label="Order summary">
                <div class="card">
                  <div class="card__hd">
                    <h2 class="card__title">Summary</h2>
                  </div>
                  <div class="card__body">
                    <dl class="summary-list">
                      <div class="summary-row summary-row--total">
                        <dt>Subtotal</dt>
                        <dd><strong><%= subtotalDisplay %></strong></dd>
                      </div>
                    </dl>
                    <p class="prose small">
                      Taxes and shipping are calculated at checkout.
                    </p>
                  </div>
                  <div class="card__ft">
                    <form method="post" action="/checkout">
                      <% if (csrfToken) { %>
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <% } %>
                      <button class="button primary" type="submit">
                        Checkout
                      </button>
                    </form>
                  </div>
                </div>
              </aside>
            </div>
          <% } %>


        </div>
      </section>
    </main>

    <%- include('../partials/footer') %>
  </body>
</html>
