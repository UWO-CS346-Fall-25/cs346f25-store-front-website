<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head', { title: 'Admin · Users', cssFiles: ['admin/dashboard.css', 'admin.css', 'admin/logs.css'], scripts: [] }) %>
<body>
  <%- include('../partials/navbar') %>

  <main id="main-content">
    <section class="section" aria-labelledby="admin-users-heading">
      <div class="container">
        <div class="section__header admin-page-header">
          <div>
            <h1 id="admin-users-heading" class="section__title">Users & Profiles</h1>
            <p class="muted">List of registered users and basic profile metadata.</p>
          </div>
          <div>
            <a href="/admin" class="link"><%- include('../icon', { name: 'back'}) %> Back to Dashboard</a>
          </div>
        </div>

        <%- include('../partials/flash') %>

        <section class="admin-panel">
          <% const rows = users || []; const page = (paging && paging.page) || 1; const perPage = (paging && paging.perPage) || 10; const totalPages = (paging && paging.totalPages) || 1; const qVal = (typeof q !== 'undefined' && q) ? q : (typeof query !== 'undefined' && query.q ? query.q : ''); %>

          <form method="get" action="" style="margin-bottom:0.75rem;display:flex;gap:0.5rem;align-items:center;">
            <input type="text" name="q" value="<%= qVal %>" placeholder="Search users by email, name, or metadata" style="flex:1;padding:0.4rem;border:1px solid #ddd;border-radius:4px;" />
            <input type="hidden" name="perPage" value="<%= perPage %>" />
            <button class="btn" type="submit">Search</button>
            <% if (qVal) { %>
              <a class="link" href="?perPage=<%= perPage %>">Clear</a>
            <% } %>
          </form>
          <% if (!rows.length) { %>
            <p class="muted">No users found.</p>
          <% } else { %>
            <div class="admin-table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th></th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Last sign in</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% 
                    const roleClassFor = (role) => {
                      if (!role) return 'level-info';
                      const r = String(role).toLowerCase();
                      switch (r) {
                        case 'admin':
                        case 'staff':
                        case 'manager':
                          return 'level-system';
                        case 'moderator':
                          return 'level-warn';
                        case 'banned':
                        case 'suspended':
                          return 'level-error';
                        case 'user':
                        default:
                          return 'level-info';
                      }
                    };
                  %>
                  <% rows.forEach(function (u) { %>
                    <% 
                      // Determine role from app metadata (raw_app_meta_data), fallback to user/app metadata or u.role
                      let rawRole = null;
                      if (u && u.raw_app_meta_data) {
                        rawRole = u.raw_app_meta_data.role || u.raw_app_meta_data.app && u.raw_app_meta_data.app.role;
                      }
                      if (!rawRole && u && u.app_metadata) rawRole = u.app_metadata.role;
                      if (!rawRole && u && u.user_metadata) rawRole = u.user_metadata.role;
                      if (!rawRole && u && u.role) rawRole = u.role;
                      const normRole = rawRole ? String(rawRole).toLowerCase() : 'user';
                      const roleDisplay = normRole ? (normRole.charAt(0).toUpperCase() + normRole.slice(1)) : '—';
                    %>
                    <tr>
                      <td class="col-role"><div class="<%= roleClassFor(normRole) %>"><span class="badge"><%= roleDisplay %></span></div></td>
                      <td><%= u.email %></td>
                      <td><%= u.display_name || '—' %></td>
                      <td><%= roleDisplay %></td>
                      <td class="muted"><%= u.created_at ? new Date(u.created_at).toLocaleString() : '—' %></td>
                      <td class="muted"><%= u.last_sign_in_at ? new Date(u.last_sign_in_at).toLocaleString() : '—' %></td>
                      <td>
                        <!-- Set role form -->
                        <% if (normRole !== 'admin') { %>
                          <form method="post" action="/admin/users/<%= u.id %>/set-role" style="display:inline;margin-right:6px;">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                            <input type="hidden" name="role" value="admin" />
                            <button class="btn" type="submit">Make Admin</button>
                          </form>
                        <% } else { %>
                          <form method="post" action="/admin/users/<%= u.id %>/set-role" style="display:inline;margin-right:6px;">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                            <input type="hidden" name="role" value="user" />
                            <button class="btn" type="submit">Revoke Admin</button>
                          </form>
                        <% } %>

                        <!-- Ban/unban form -->
                        <% if (normRole !== 'banned') { %>
                          <form method="post" action="/admin/users/<%= u.id %>/ban" style="display:inline;">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                            <input type="hidden" name="action" value="ban" />
                            <button class="btn" type="submit">Ban</button>
                          </form>
                        <% } else { %>
                          <form method="post" action="/admin/users/<%= u.id %>/ban" style="display:inline;">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                            <input type="hidden" name="action" value="unban" />
                            <button class="btn" type="submit">Unban</button>
                          </form>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
            <div class="admin-table-pagination" style="display:flex;align-items:center;justify-content:space-between;padding-top:0.75rem;">
              <div class="muted">Page <%= page %> of <%= totalPages %></div>
              <div>
                <% const qs = (p) => {
                     const parts = ['page=' + p];
                     if (qVal) parts.push('q=' + encodeURIComponent(qVal));
                     if (perPage) parts.push('perPage=' + perPage);
                     return parts.join('&');
                   };
                %>
                <% if (page > 1) { %>
                  <a class="link" href="?<%= qs(page - 1) %>">← Prev</a>
                <% } %>
                <% if (page < totalPages) { %>
                  <% if (page > 1) { %> &nbsp; &middot; &nbsp; <% } %>
                  <a class="link" href="?<%= qs(page + 1) %>">Next →</a>
                <% } %>
              </div>
            </div>
          <% } %>
        </section>
      </div>
    </section>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
