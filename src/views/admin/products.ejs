<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head', {
  title: 'Admin · Products',
  cssFiles: ['admin/dashboard.css', 'admin.css'],
  scripts: []
}) %>
<body>
  <%- include('../partials/navbar') %>

  <main id="main-content">
    
    <header class="admin-header">
      <h1>Products Dashboard</h1>
      <p class="subtitle">Create, update, and retire products shown in your shop.
        <%- include('../partials/helper-popup', { text: 'Draft products are only visible to admins. Use the eye icon to preview drafts.' }) %>
      </p>
    </header>
    <section class="section" aria-labelledby="admin-products-heading">
      
      <div class="container">

        <%- include('../partials/flash') %>


        <!-- Summary chips -->
        <% const items = products || []; %>
        <% const activeCount = items.filter(p => p.status === 'active').length; %>
        <div class="admin-summary">
          <div class="admin-summary-card">
            <p class="admin-summary-label">Total products</p>
            <p class="admin-summary-value"><%= items.length %></p>
          </div>
          <div class="admin-summary-card">
            <p class="admin-summary-label">Active products</p>
            <p class="admin-summary-value"><%= activeCount %></p>
          </div>
        </div>

        <!-- Product list -->
        <section aria-label="Current products" class="admin-panel">
            <div class="admin-panel-header">
              <a href="/admin" class="link--button link" id="back-to-dashboard">
                
                <%- include('../icon', { name: 'back' }) %> Back to Dashboard
              </a>
              <div>
                <a href="/admin/products/new" class="link--button link" id="new-product">+ New product</a>
              </div>
            </div>
          <% if (items.length) { %>
            <div class="admin-table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Last Updated</th>
                    <th>Category</th>
                    <th class="admin-col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% items.forEach(function (product) { %>
                    <tr class="admin-product--status-<%= product.status %>">
                      <td>
                        <div class="admin-product-main">
                          <img
                            class="admin-product-thumb"
                            src="<%= product.image.url %>"
                            alt="<%= product.image.alt || 'Product image' %>">
                          <div>
                            <div class="admin-product-name">
                              <%= product.name || 'Untitled product' %>
                            </div>
                            <div class="admin-product-meta muted price">
                              <% if (typeof util !== 'undefined' && util.formatPrice) { %>
                                <%= util.formatPrice(product) %>
                              <% } else { %>
                                $<%= (product.price_cents || 0) / 100 %>
                              <% } %>
                            </div>
                            
                            <% product.categories.forEach(cat => { %>
                              <span class="badge badge--info category"><%= cat.name %></span>
                            <% }); %>
                          </div>
                        </div>
                      </td>

                      <td>
                        <div class="admin-product-meta muted">
                          <% if (typeof util !== 'undefined' && util.formatPrice) { %>
                            <%= util.formatPrice(product) %>
                          <% } else { %>
                            $<%= (product.price_cents || 0) / 100 %>
                          <% } %>
                        </div>
                      </td>


                      <td>
                        <span class="admin-product-meta muted">
                          <%= product.updated_at
                            ? new Date(product.updated_at).toLocaleDateString('en-US')
                            : '—' %>
                        </span>
                      </td>


                      <td>
                        <% product.categories.forEach(cat => { %>
                          <span class="badge badge--info"><%= cat.name %></span>
                        <% }); %>
                      </td>


                      <td>
                        <div class="admin-actions">
                          <!-- View on storefront -->
                          
                          <% if (product.status == 'active') { %>
                            <span class="helper-popup" tabindex="0" aria-haspopup="true">
                              <a class="link link--icon" href="/shop/<%= product.slug %>" target="_blank" rel="noopener">
                                <span class="sr-only">View</span>
                                <%- include('../icon', { name: 'eye-open' }) %>
                              </a>
                              <span class="helper-popup__text" role="tooltip">View</span>
                            </span>
                          <% } else { %>
                            <span class="helper-popup" tabindex="0" aria-haspopup="true">
                              <a class="link link--icon" href="/shop/<%= product.slug %>" target="_blank" rel="noopener">
                                <span class="sr-only">View Draft</span>
                                <%- include('../icon', { name: 'eye-closed-danger' }) %>
                              </a>
                              <span class="helper-popup__text" role="tooltip">View Draft</span>
                            </span>
                          <% } %>

                          <span class="helper-popup" tabindex="0" aria-haspopup="true">
                            <a class="link link--icon" href="/admin/products/<%= product.id %>/edit">
                              <span class="sr-only">Edit</span>
                              <%- include('../icon', { name: 'edit' }) %>
                            </a>
                            <span class="helper-popup__text" role="tooltip">Edit</span>
                          </span>
                          <!-- Delete (POST/DELETE) -->
                          <form
                            method="post"
                            action="/admin/products/<%= product.id %>/delete"
                            class="admin-inline-form"
                            onsubmit="return confirm('Delete this product? This cannot be undone.');">
                            <% if (csrfToken) { %>
                              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <% } %>
                            <span class="helper-popup" tabindex="0" aria-haspopup="true">
                              <%- include('../partials/confirm-button', {
                                btnClasses: 'link link--danger admin-delete-link link--icon',
                                iconName: 'trash',
                                label: 'Delete',
                                modalTitle: 'Delete product',
                                modalBody: 'Delete this product? This cannot be undone.',
                                confirmText: 'Delete',
                                cancelText: 'Cancel'
                              }) %>
                              <span class="helper-popup__text" role="tooltip">Delete</span>
                            </span>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="muted">No products yet. Create your first one below.</p>
          <% } %>
        </section>

  </main>

  <%- include('../partials/footer') %>
</body>
</html>
